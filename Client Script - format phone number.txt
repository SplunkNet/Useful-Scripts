------------------------------------------   CLIENT SCRIPT   ------------------------------------------

Description:
 Re-usable code to check the validity of a phone number against the North American Number Plan.  Call the script include and pass it the value of the field that needs to be validated.  The script include will validate and format as necessary.  If the returned answer has no value, then don't update the field on the form...this stops the infinite loop.

 Details:
 * Area codes start with a number 2–9, followed by 0–8, and then any third digit.
 * The second group of three digits, known as the central office or exchange code, starts with a number // 2–9, followed by any two digits.
 * The final four digits, known as the station code, have no restrictions.

* A leading 1 is option for input, but will be set on output. this is to facilitate the ServiceNow column type of Phone Number E164.
* It will accept hyphens, periods, and spaces as group separators.  E.g. 1-248-555-1212 or 1.248.555.1212. or 1 248 555 1212 or any combo there in.
* It will accept  no separators too:  E.g. 12485551212 or any combo there in (1248 555.1212)

function onChange(control, oldValue, newValue, isLoading) {
   if ((isLoading || newValue == '') )   {
      return;
   }

	// set the name of the variable that contains the phone number.  Rest of code below does not need changes.
	var variableName = 'u_alternate_phone';
	
	//g_form.addInfoMessage("Debug: in onchange client script;  " + "newValue=" + newValue + ", oldValue="+ oldValue);
	g_form.clearMessages();
	
	//force the the newValue to a javascript string type.  this avoids an ambigous string type used in the RegEx in the script include
	var rawPhoneNumber = g_form.getValue(variableName).toString();
	// call the script include and pass it the raw phone number.
	var ga = new GlideAjax('u_FormatPhoneNumber');
	ga.addParam('sysparm_name','formatPhoneNumber');
	ga.addParam('sysparm_phone_number',rawPhoneNumber);
	ga.getXML(callbackfunction); // call back function so we don't lock up the client waiting for the return trip from the server.
	
	function callbackfunction(response){
		var answer = response.responseXML.documentElement.getAttribute("answer");
		// if we get an answer, then it means the include script formatted the phone value, so lets set it int the field.
		// otherwise do nothing...do not update the field.
		if (answer) {
			g_form.setValue(variableName,answer);
			return;
		}
	}

}



------------------------------------------   SCRIPT INCLUDE  ------------------------------------------

Description:
Include script to check the validity of a phone number against the North American Number Number Plan.
Accepted values are in this format:

* Area codes start with a number 2–9, followed by 0–8, and then any third digit.
* The second group of three digits, known as the central office or exchange code, starts with a number 2–9, followed by any two digits.
* The final four digits, known as the station code, have no restrictions.

A leading 1 is option for input, but will be set on output. this is to facilitate the ServiceNow column type of Phone Number E164.
It will accept hyphens, periods, and spaces as group separators.  E.g. 1-248-555-1212 or 1.248.555.1212. or 1 248 555 1212 or any combo there in.
It will accept  no separators too:  E.g. 12485551212 or any combo there in (1248 555.1212)



var u_FormatPhoneNumber = Class.create();
u_FormatPhoneNumber.prototype = Object.extendsObject(AbstractAjaxProcessor, {

	formatPhoneNumber:function(){
		var phoneNumber = this.getParameter('sysparm_phone_number') + '';
		var finalFormat = "1 ($1) $2-$3";
		// Valid numbers in position according to NANP
		var allowedFormat= /^(?:\+?1[-. ]?)?\(?([2-9][0-8][0-9])\)?[-. ]?([2-9][0-9]{2})[-. ]?([0-9]{4})$/;
		// final format:  1 (234) 567-8900
		var finalFormatTest= /^(1[ ])\(([2-9][0-8][0-9])\)[ ]([2-9][0-9]{2})[-]([0-9]{4})$/;
		var phoneNumberFormatted;

		// if the phone number is already in the final format, then exit the script and do not return a value.
		// this helps stop the infinite loop for the On Change in the client script.
		if (finalFormatTest.test(phoneNumber)) {
			return;
		}

		// if the phone number is not in the final format, then validate it is a valid number and format it.
		if (allowedFormat.test(phoneNumber)) {
			phoneNumberFormatted = phoneNumber.replace(allowedFormat, finalFormat);
		} else {
			// if the phone number is not valid, then post a message to the user.
			gs.addErrorMessage('Enter a valid 10 digit phone number','error');
		}
		
		return phoneNumberFormatted;
	},
		

	type: 'u_FormatPhoneNumber'
});
	

	
